<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Smart farm - Controller</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <!--Google Fonts and Icons-->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/js-circle-progress/dist/circle-progress.min.js" type="module"></script>
    <link rel="shortcut icon" href="https://i.pinimg.com/474x/ef/f6/ac/eff6acfcf843833a9b21070769dae764.jpg"
    type="image/x-icon">
    <!-- style path -->
    <link rel="stylesheet" href="../assets/style.css" type="text/css" media="all" />
</head>

<body>
    <!--navbar -->
    <nav class="navbar navbar-expand-lg" style="background:white;">
        <div class="container-fluid">
            <img src="../assets/logo.png" style="width: 50px;" alt="">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="bi bi-list"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active fw-bold" href="/">Controller</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!--navbar -->

    <main class="m-0">
        <div class="w-100 py-3 d-flex flex-column justify-content-center align-items-center bg-primarys gap-2"
            id="body-append-value-sensor">
            <div class="d-flex gap-2">
                <div class="d-flex flex-column p-2 box-sensor position-relative d-flex justify-content-center align-items-center"
                    style="background:#F2613F">
                    <p class="m-0 position-absolute" style="left:10px;top:5px">
                        Temperature
                    </p>
                    <h1 style="font-size:3em" class="m-0 mt-2 fw-bold" id="display-temp">0</h1>
                    <p class="m-0" id="sublime-temp">
                        Loading..
                    </p>
                    <p class="m-0 position-absolute" style="right:10px;top:5px">
                        Â°C
                    </p>
                </div>
                <div
                    class="d-flex flex-column p-2 box-sensor position-relative d-flex justify-content-center align-items-center">
                    <p class="m-0 position-absolute" style="left:10px;top:5px">
                        Kel. Udara
                    </p>
                    <h1 style="font-size:3em" class="m-0 mt-2 fw-bold" id="display-humidity">0</h1>
                    <p class="m-0" id="sublime-humidity">
                        Loading..
                    </p>
                    <p class="m-0 position-absolute" style="right:10px;top:5px">
                        %
                    </p>
                </div>
            </div>
            <div class="d-flex gap-2">
                <div class="d-flex flex-column p-2 box-sensor position-relative d-flex justify-content-center align-items-center"
                    style="background:#FF204E">
                    <p class="m-0 position-absolute" style="left:10px;top:5px">
                        Kel. Tanah 1
                    </p>
                    <h1 style="font-size:3em" class="m-0 mt-2 fw-bold" id="display-moisture1">0</h1>
                    <p class="m-0" id="sublime-moisture1">
                        Loading..
                    </p>
                    <p class="m-0 position-absolute" style="right:10px;top:5px">
                        %
                    </p>
                </div>
                <div class="d-flex flex-column p-2 box-sensor position-relative d-flex justify-content-center align-items-center"
                    style="background:gray">
                    <p class="m-0 position-absolute" style="left:10px;top:5px">
                        Kel. Tanah 2
                    </p>
                    <h1 style="font-size:3em" class="m-0 mt-2 fw-bold" id="display-moisture2">00</h1>
                    <p class="m-0" id="sublime-moisture2">
                        Comming soon..
                    </p>
                    <p class="m-0 position-absolute" style="right:10px;top:5px">
                        %
                    </p>
                </div>
            </div>
        </div>
        <div class="container mt-4 d-flex flex-column">
            <h1 class="color-primary2 m-0 fw-bold">Farming Controller</h1>
            <p class="">
                Controll your farming in here (pastikan server sudah menyala dengan mengklik button 'START
                SERVER' dibawah)
            </p>
            <div class="d-flex gap-2 mt-2 align-items-center">
                <p class="m-0">
                    Kondisi Tanaman :
                </p>
                <div id="kondisi-tanaman">
                    <p class="bg-primarys m-0 px-3 py-1">
                        Loading..
                    </p>
                </div>
            </div>
            <div class="d-flex gap-2 mt-2 align-items-center">
                <p class="m-0">
                    System Farming :
                </p>
                <select name="" onchange="changeSystem(this)" class="bg-primarys border-0 px-3 py-1" value=""
                    id="system_mode_input">
                    <option value="" hidden>Loading..</option>
                    <option value="automatic">automatic</option>
                    <option value="manual">manual</option>
                    <option value="schedule">schedule</option>
                </select>
            </div>
            <div class="flex-wrap mt-3" id="auto-popup" style="display:none;">
                <h1 class="m-0">Automatic system</h1>
                <div class="d-flex gap-2 mt-2 align-items-center">
                    <p class="m-0">
                        Middle temperature (jika turun dingin, jika naik panas) :
                    </p>
                    <input class="form-control" id="mid-temp" type="number" />
                </div>
                <div class="d-flex gap-2 mt-2 align-items-center">
                    <p class="m-0">
                        Middle humidity (jika turun kering, jika naik lembab) :
                    </p>
                    <input class="form-control" id="mid-humi" type="number" />
                </div>
                <div class="d-flex gap-2 mt-2 align-items-center">
                    <p class="m-0">
                        Middle moisture1 (jika turun kering, jika naik lembab) :
                    </p>
                    <input class="form-control" id="mid-moisture1" type="number" />
                </div>
                <button class="btn btn-success" type="button" onclick="saveAutoMode()">Save</button>
            </div>
            <div class="flex-wrap mt-3" id="schedule-popup" style="display:none;">
                <h1 class="m-0">Scheduling system</h1>
                <div class="d-flex gap-2 mt-2 align-items-center">
                    <p class="m-0 col-4">
                        Pagi :
                    </p>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="pagi-ipt">
                        <div class="input-group-append">
                            <span class="input-group-text">:00</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 mt-2 align-items-center">
                    <p class="m-0 col-4">
                        Siang :
                    </p>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="siang-ipt">
                        <div class="input-group-append">
                            <span class="input-group-text">:00</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 mt-2 align-items-center">
                    <p class="m-0 col-4">
                        Sore :
                    </p>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="sore-ipt">
                        <div class="input-group-append">
                            <span class="input-group-text">:00</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 mt-2 align-items-center">
                    <p class="m-0 col-4">
                        Malam :
                    </p>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="malam-ipt">
                        <div class="input-group-append">
                            <span class="input-group-text">:00</span>
                        </div>
                    </div>
                </div>
                <button class="btn m-2 btn-success" onclick="saveScheduleMode()" type="button">Save</button>
            </div>
            <canvas id="myChart" class="my-3" style="width:100%;max-width:700px"></canvas>
            <canvas id="myChartTemp" class="my-3" style="width:100%;max-width:700px"></canvas>
            <div class="container d-flex justify-content-center mt-3 mb-3">
                <button class="btn-on-off btno-active" id="btns-on" style="display:flex" onclick="server('on')">START
                    SERVER</button>
                <button class="btn-on-off btno-active"
                    style="display:none;background:#FF2842 !important;border:3px solid #FF2842 !important;"
                    id="btns-off" onclick="server('off')">TURN OFF SERVER</button>
            </div>
        </div>
    </main>

    <!--popup alert-->
    <div class="m-0 w-100 shadow-lg position-fixed py-3" id="popup-alert"
        style="display:none;bottom:0;left:0; background:white; z-index:999;">
        <div class="container d-flex flex-column" style="background:white;">
            <h1 class="m-0">Recently Alert</h1>
            <div class="bar d-flex align-items-center gap-3 my-2">
                <p class="m-0 btna-active" id="btna-plant" onclick="showAlert('plant', this)">
                    Plant
                </p>
                <p class="m-0" id="btna-sensor" onclick="showAlert('sensor', this)">
                    Sensor
                </p>
                <p class="m-0" id="btna-pump-fan" onclick="showAlert('pump-fan', this)">
                    Pump/Fan
                </p>
            </div>
            <div class="display-alert flex-column  overflow-y-scroll px-2 rounded-2"
                style="width:100%;height:200px; background:rgba(0,0,0,.1);" id="alert-plant">
            </div>
            <div class="display-alert flex-column overflow-y-scroll px-2 rounded-2"
                style="display:none;width:100%;height:200px; background:rgba(0,0,0,.1);" id="alert-sensor">
            </div>
            <div class="display-alert flex-column  overflow-y-scroll px-2 rounded-2"
                style="display:none;width:100%;height:200px; background:rgba(0,0,0,.1);" id="alert-pump-fan">
            </div>
        </div>

        <button class="btn btn-danger position-absolute" onclick="closeAlert()" style="right:15px;top:15px;">X</button>
    </div>
    <!--popup alert-->

    <!--popup button-->
    <div class="m-0 w-100 shadow-lg position-fixed py-3" id="popup-btn"
        style="display:none;bottom:0;left:0; background:white; z-index:999;">
        <div class="container d-flex flex-column" style="background:white;">
            <h1 class="m-0">Control Pump or Fan</h1>
            <div class="display-alert mt-3 rounded-2 overflow-y-scroll"
                style="width:100%;height:200px; background:rgba(0,0,0,.1);">
                <div class="w-100 mt-3 container d-flex text-center gap-2 justify-content-center">
                    <div class="d-flex flex-column justify-content-center">
                        <h5 class="m-0 pb-1 fw-bold" style="color:#386c5f">Pump1</h5>
                        <div class="d-flex gap-2">
                            <button class="btn-on-off" id="pump1-btn-on" onclick="pumpButton('on', this, 1)">ON</button>
                            <button class="btn-on-off btno-active" id="pump1-btn-off"
                                onclick="pumpButton('off', this, 1)">OFF</button>
                        </div>
                    </div>
                    <div class="d-flex flex-column justify-content-center">
                        <h5 class="m-0 pb-1 fw-bold" style="color:#386c5f">Fan1</h5>
                        <div class="d-flex gap-2">
                            <button class="btn-on-off" id="fan1-btn-on" onclick="fanButton('on', this, 1)">ON</button>
                            <button class="btn-on-off btno-active" id="fan1-btn-off"
                                onclick="fanButton('off', this, 1)">OFF</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button class="btn btn-danger position-absolute" onclick="closeButton()" style="right:15px;top:15px;">X</button>
    </div>
    <!--popup button-->

    <!--btn popup button-->
    <button class="position-fixed justify-content-center align-items-center bg-primarys border-0" id="btn-btn"
        style="display:none;border-radius:50%;width:50px; height:50px;right:10px;bottom:70px;" onclick="openButton()"><i
            class="bi bi-hammer"></i></button>
    <!--btn popup button-->

    <!--btn popup alert-->
    <button class="position-fixed justify-content-center align-items-center bg-primarys border-0" id="btn-alert"
        style="display:none;border-radius:50%;width:50px; height:50px;right:10px;bottom:10px;"
        onclick="openAlert()"><i class="bi bi-bell"></i></button>
    <!--btn popup alert-->
    <script src="https://www.gstatic.com/firebasejs/9.12.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.12.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.12.1/firebase-storage-compat.js"></script>
    <script src="../assets/main.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" charset="utf-8">

        const firebaseConfig = {
            databaseURL: "https://controler-smart-farm-default-rtdb.firebaseio.com/"
        }
        firebase.initializeApp(firebaseConfig)

        const database = firebase.database();
        const URL = "https://controler-smart-farm-default-rtdb.firebaseio.com/"
        const xValues = ["Pagi", "Siang", "Sore", "Malam"];
        const tempValues = [];
        const humiValues = [];
        const moistureValues1 = [];
        var statusServer = 0;
        var autoMode = 0
        var scheduleMode = 0

        // Creating the chart
        var myChart = new Chart("myChart", {
            type: "bar",
            data: {
                labels: xValues,
                datasets: [{
                    label: "Humidity", // Second dataset
                    fill: false,
                    lineTension: 0,
                    backgroundColor: "#512B81",
                    borderColor: "rgba(81, 43, 129, 0.8)",
                    data: humiValues,
                    stepped: true
                },
                    {
                        label: "Moisture1", // Third dataset
                        fill: false,
                        lineTension: 0,
                        backgroundColor: "rgba(255, 32, 78, 1)",
                        borderColor: "rgba(255, 32, 78, 0.7)",
                        data: moistureValues1
                    }]
            },
            options: {
                responsive: true,
                legend: {
                    display: true
                }, // Display legend to differentiate datasets
                scales: {
                    yAxes: [{
                        ticks: {
                            min: 0,
                            max: 100
                        }
                    }]
                },
                animation: {
                    duration: 1000, // Duration of the animation in milliseconds
                    easing: 'easeInOutQuart' // Easing function for a smoother transition
                }
            }
        });
        var myChartTemp = new Chart("myChartTemp", {
            type: "bar",
            data: {
                labels: xValues,
                datasets: [{
                    label: "Temperature", // Second dataset
                    fill: false,
                    lineTension: 0,
                    backgroundColor: "#800300",
                    borderColor: "rgb(128, 3, 0, 0.8)",
                    data: tempValues,
                    stepped: true
                }]
            },
            options: {
                responsive: true,
                legend: {
                    display: true
                }, // Display legend to differentiate datasets
                scales: {
                    yAxes: [{
                        ticks: {
                            min: 0,
                            max: 7,
                            callback: function(value, index, ticks) {
                                switch (value) {
                                    case 0:
                                        return '21.0';
                                        case 1:
                                            return '21.3';
                                            case 2:
                                                return '21.5';
                                                case 3:
                                                    return '22.0';
                                                    case 4:
                                                        return '22.3';
                                                        case 5:
                                                            return '22.5';
                                                            case 6:
                                                                return '22.8';
                                                                case 7:
                                                                    return '23.0';
                                                            }
                                                    }
                                            }
                                    }]
                            },
                            animation: {
                                duration: 1000, // Duration of the animation in milliseconds
                                easing: 'easeInOutQuart' // Easing function for a smoother transition
                            }
                        }
                    });

                    // Function to automatically update the chart data
                    function updateChartHM(humi, moisture1) {
                        humiValues.push(humi); // Adding random humidity data
                        moistureValues1.push(moisture1); // Adding random moisture data

                        // Shift xValues if needed (for example, if using timestamps)
                        if (xValues.length > 10) {
                            // Keep max 10 data points, can adjust accordingly
                            humiValues.shift();
                            moistureValues1.shift();
                        }

                        myChart.update(); // Update the chart with new data
                    }
                    function updateChartT(temp) {
                        tempValues.push(temp);
                        if (xValues.length > 10) {
                            tempValues.shift();
                        }

                        myChartTemp.update(); // Update the chart with new data
                    }
                    updateChartHM(10, 90)
                    updateChartT(5)


                    function showAlert(type, elem) {
                        var btnPlant = document.getElementById("btna-plant")
                        var btnSensor = document.getElementById("btna-sensor")
                        var btnPumpFan = document.getElementById("btna-pump-fan")
                        var pPlant = document.getElementById("alert-plant")
                        var pSensor = document.getElementById("alert-sensor")
                        var pPumpFan = document.getElementById("alert-pump-fan")

                        btnPlant.classList.remove("btna-active")
                        btnSensor.classList.remove("btna-active")
                        btnPumpFan.classList.remove("btna-active")
                        pPlant.style.display = "none"
                        pSensor.style.display = "none"
                        pPumpFan.style.display = "none"
                        elem.classList.add("btna-active")

                        if (type === 'plant') {
                            pPlant.style.display = "flex"
                        } else if (type === 'sensor') {
                            pSensor.style.display = "flex"
                        } else if (type === 'pump-fan') {
                            pPumpFan.style.display = "flex"
                        }
                    }

                    function pumpButton(type, elem, pumpNumber) {
                        var pinBtnOn = "pump" + pumpNumber + "-btn-on"
                        var pinBtnOff = "pump" + pumpNumber + "-btn-off"
                        var btnOn = document.getElementById(pinBtnOn);
                        var btnOff = document.getElementById(pinBtnOff);
                        btnOn.classList.remove("btno-active");
                        btnOff.classList.remove("btno-active");

                        var pumpStatus = (type === 'on') ? 1: 0; // Pump ON or OFF

                        if (type === 'on') {
                            elem.classList.add("btno-active");
                            fetch(URL + "dataRelay.json", {
                                method: "PATCH",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({
                                    ["pump" + pumpNumber]: 1
                            })
                            })
                        .then(res => {
                            if (res.ok) {
                                Toast.fire({
                                    icon: "success",
                                    title: "Pump" + pumpNumber + " berhasil nyala."
                            });
                        }
                        })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                } else if (type === 'off') {
                    elem.classList.add("btno-active");
                    fetch(URL + "dataRelay.json", {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            ["pump" + pumpNumber]: 0
                        })
                    })
                    .then(res => {
                        if (res.ok) {
                            Toast.fire({
                                icon: "success",
                                title: "Pump" + pumpNumber + " berhasil mati."
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                }

            }

            function fanButton(type, elem, fanNumber) {
                var pinBtnOn = "fan" + fanNumber + "-btn-on"
                var pinBtnOff = "fan" + fanNumber + "-btn-off"
                var btnOn = document.getElementById(pinBtnOn);
                var btnOff = document.getElementById(pinBtnOff);
                btnOn.classList.remove("btno-active")
                btnOff.classList.remove("btno-active")

                var fanStatus = (type === 'on') ? 1: 0; // Pump ON or OFF

                if (type === 'on') {
                    elem.classList.add("btno-active");
                    fetch(URL + "dataRelay.json", {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            ["fan" + fanNumber]: 1
                        })
                    })
                    .then(res => {
                        if (res.ok) {
                            Toast.fire({
                                icon: "success",
                                title: "Fan" + fanNumber + " berhasil nyala."
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                } else if (type === 'off') {
                    elem.classList.add("btno-active");
                    fetch(URL + "dataRelay.json", {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            ["fan" + fanNumber]: 0
                        })
                    })
                    .then(res => {
                        if (res.ok) {
                            Toast.fire({
                                icon: "success",
                                title: "Fan" + fanNumber + " berhasil mati."
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                }
            }

            function server(state) {
                let stateFix;
                if (state === "on") {
                    stateFix = 1
                } else if (state === "off") {
                    stateFix = 0
                }
                if (state === "off") {
                    fetch(URL + "dataFarm.json", {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            temperature: 0,
                            humidity: 0,
                            moisture1: 0
                        })
                    })
                    .then(res => {
                        if (res.ok) {
                           fetch(URL + "dataOperation.json", {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            pagi_done: 0,
                            siang_done: 0,
                            sore_done: 0,
                            malam_done: 0
                        })
                    })
                    .then(res => {
                        if (res.ok) {
                            return
                        }
                    }) 
                        }
                    })
                }
                fetch(URL + "config.json",
                    {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            server: stateFix
                        })
                    })
                .then(res => {
                    if (res.ok) {
                        if (state === "on") {
                            Swal.fire({
                                title: "Berhasil !",
                                text: 'server on',
                                icon: "success"
                            });
                        } else if (state === "off") {
                            Swal.fire({
                                title: "Berhasil !",
                                text: 'server off',
                                icon: "success"
                            });
                        }
                    }
                })
            }

            function changeSystem(elem) {
                var value = elem.value;
                fetch(URL + "config.json",
                    {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            sf_operation: value
                        })
                    })
                .then(res => {
                    if (res.ok) {
                        getSystemFarm()
                        Swal.fire({
                            title: "Berhasil !",
                            text: 'mengganti system ke ' + value,
                            icon: "success"
                        });
                    }
                })
            }

            function getSystemFarm() {
                fetch(URL + "config.json")
                .then(res => res.json())
                .then(data => {
                    document.getElementById('system_mode_input').value = data.sf_operation
                    if (data.sf_operation === "automatic") {
                        document.getElementById("auto-popup").style.display = "flex"
                        autoMode = 1
                    } else if (data.sf_operation === "schedule") {
                        document.getElementById("schedule-popup").style.display = "flex"
                        scheduleMode = 1
                    } else {
                        document.getElementById("auto-popup").style.display = "none"
                        document.getElementById("schedule-popup").style.display = "none"
                        autoMode = 0
                        scheduleMode = 0
                    }
                })
            }

            function getStatusServer() {
                var btnBtn = document.getElementById("btn-btn")
                var btnAlert = document.getElementById("btn-alert")
                fetch(URL + "config.json")
                .then(res => res.json())
                .then(data => {
                    var btnOn = document.getElementById("btns-on")
                    var btnOff = document.getElementById("btns-off")
                    if (data.server == 0) {
                        btnOn.style.display = "flex"
                        btnOff.style.display = "none"
                        btnBtn.style.display = "none"
                        btnAlert.style.display = "none"
                        statusServer = 0
                    } else if (data.server == 1) {
                        btnOn.style.display = "none"
                        btnOff.style.display = "flex"
                        btnBtn.style.display = "flex"
                        btnAlert.style.display = "flex"
                        statusServer = 1
                    }
                })
            }

            database.ref("dataFarm").on('value', snapshot => {
                if (statusServer === 0) {
                    var changeKondisiTanaman = document.getElementById("kondisi-tanaman");
                    changeKondisiTanaman.innerHTML = '<p class="bg-danger text-light m-0 px-3 py-1">Server not started</p>';
                    return;
                }
                var data = snapshot.val()
                if (data) {
                    var moistureValue1 = parseFloat(data.moisture1);
                    var changeKondisiTanaman = document.getElementById("kondisi-tanaman");

                    if (moistureValue1 === 0 || moistureValue1 <= 50) {
                        changeKondisiTanaman.innerHTML = '<p class="bg-danger text-light m-0 px-3 py-1">Kering</p>';
                    } else if (moistureValue1 > 90) {
                        changeKondisiTanaman.innerHTML = '<p class="bg-primary text-light m-0 px-3 py-1">Tanah lembab</p>';
                    } else {
                        changeKondisiTanaman.innerHTML = '<p class="bg-danger text-light m-0 px-3 py-1">Moisture not found</p>';
                    }

                    if (!data.error) {
                        var textTemp = document.getElementById("display-temp");
                        var textHumidity = document.getElementById("display-humidity");
                        var textMoisture1 = document.getElementById("display-moisture1");
                        var sublimeTemp = document.getElementById("sublime-temp");
                        var sublimeHumidity = document.getElementById("sublime-humidity");
                        var sublimeMoisture1 = document.getElementById("sublime-moisture1");

                        var intTemp = parseFloat(data.temperature);
                        var intHumidity = parseFloat(data.humidity);
                        var intMoisture1 = parseFloat(data.moisture1);

                        // Mengubah angka menjadi dua digit (01, 02, dst.)
                        var formattedTemp = String(intTemp).padStart(2, '0');
                        var formattedHumidity = String(intHumidity).padStart(2, '0');
                        var formattedMoisture1 = String(intMoisture1).padStart(2, '0');

                        textTemp.innerText = formattedTemp;
                        textHumidity.innerText = formattedHumidity;
                        textMoisture1.innerText = formattedMoisture1;

                        // Kondisi untuk temperature
                        if (intTemp === 0) {
                            sublimeTemp.textContent = "nothing";
                        } else if (intTemp > 20) {
                            sublimeTemp.textContent = "panas";
                        } else if (intTemp < 20) {
                            sublimeTemp.textContent = "dingin";
                        } else if (intTemp === 21) {
                            sublimeTemp.textContent = "stabil";
                        } else {
                            sublimeTemp.textContent = "error";
                        }

                        // Kondisi untuk humidity
                        if (intHumidity === 0) {
                            sublimeHumidity.textContent = "nothing";
                        } else if (intHumidity > 20) {
                            sublimeHumidity.textContent = "lembab";
                        } else if (intHumidity < 20) {
                            sublimeHumidity.textContent = "dingin";
                        } else if (intHumidity === 20) {
                            sublimeHumidity.textContent = "stabil";
                        } else {
                            sublimeHumidity.textContent = "error";
                        }

                        // Kondisi untuk moisture
                        if (intMoisture1 === 0) {
                            sublimeMoisture1.textContent = "nothing";
                        } else if (intMoisture1 > 50) {
                            sublimeMoisture1.textContent = "lembab";
                        } else if (intMoisture1 < 50) {
                            sublimeMoisture1.textContent = "kering";
                        } else if (intMoisture1 === 30) {
                            sublimeMoisture1.textContent = "stabil";
                        } else {
                            sublimeMoisture1.textContent = "error";
                        }
                    }
                } else {
                    alert("HTTP error");
                }
            })

            function getAlert() {
                fetch(URL + "alert.json")
                .then(res => res.json())
                .then(data => {
                    for (let key in data) {
                        var val = data[key]
                        var newEl = document.createElement("div")
                        newEl.innerHTML = `
                        <div class="d-flex flex-column rounded-2 bg-warning container w-100 my-2 py-2" style="">
                        <p class="m-0">${val.title}</p>
                        <p class="m-0" style="font-size:.7em">Created by ${val.created_by}, ${val.created_at}</p>
                        <p class="m-0" style="font-size:.7em">${val.message}</p>
                        </div>
                        `;
                        if (val.type === "plant") {
                            document.getElementById("alert-plant").appendChild(newEl)
                        } else if (val.type === 'sensor') {
                            document.getElementById("alert-sensor").appendChild(newEl)
                        } else if (val.type === 'pump-fan') {
                            document.getElementById("alert-pump-fan").appendChild(newEl)
                        } else {
                            alert('error display alert.')
                        }
                    }
                })
            }

            database.ref("dataRelay").on('value', snapshot => {
                var data = snapshot.val();
                var statusPumps = [];
                var statusFans = [];

                // Loop through each key-value pair in the JSON data
                for (let i = 1; i < 11; i++) {
                    statusPumps[i] = data['pump' + i]; // Get the status (0 or 1)
                    statusFans[i] = data['fan' + i]; // Get the status (0 or 1)

                    // Check if pump status exists (even if it's 0)
                    if (typeof statusPumps[i] !== 'undefined') {
                        // Update pump buttons if status has changed
                        var btnOnPump = document.getElementById('pump' + i + '-btn-on');
                        var btnOffPump = document.getElementById('pump' + i + '-btn-off');

                        if (statusPumps[i] == 1) {
                            btnOnPump.classList.add("btno-active");
                            btnOffPump.classList.remove("btno-active");
                        } else if (statusPumps[i] == 0) {
                            btnOnPump.classList.remove("btno-active");
                            btnOffPump.classList.add("btno-active");
                        }
                    }

                    // Check if fan status exists (even if it's 0)
                    if (typeof statusFans[i] !== 'undefined') {
                        // Update fan buttons if status has changed
                        var btnOnFan = document.getElementById('fan' + i + '-btn-on');
                        var btnOffFan = document.getElementById('fan' + i + '-btn-off');

                        if (statusFans[i] == 1) {
                            btnOnFan.classList.add("btno-active");
                            btnOffFan.classList.remove("btno-active");
                        } else if (statusFans[i] == 0) {
                            btnOnFan.classList.remove("btno-active");
                            btnOffFan.classList.add("btno-active");
                        }
                    }
                }
            });

            var midTempValue = 0
            var midHumiValue = 0
            var midMoisture1Value = 0
            var pagiTime = 0
            var siangTime = 0
            var soreTime = 0
            var malamTime = 0

            const Toast = Swal.mixin({
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });

            let lastTemperature = null;
            let lastMoisture1 = null;
            function saveAutoMode() {
                var midTemp = document.getElementById("mid-temp").value
                var midHumi = document.getElementById("mid-humi").value
                var midMoisture1 = document.getElementById("mid-moisture1").value
                fetch(URL + "dataOperation.json",
                    {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            mid_temp: midTemp,
                            mid_humidity: midHumi,
                            mid_moisture1: midMoisture1
                        })
                    })
                .then(res => {
                    if (res.ok) {
                        Toast.fire({
                            icon: "success",
                            title: "Pengaturan disimpan."
                        });
                    }
                })
            }
            function loadAutoMode() {
                var midTemp = document.getElementById("mid-temp")
                var midHumi = document.getElementById("mid-humi")
                var midMoisture1 = document.getElementById("mid-moisture1")
                fetch(URL + "dataOperation.json")
                .then(res => res.json())
                .then(data => {
                    midTemp.value = parseFloat(data.mid_temp)
                    midHumi.value = parseInt(data.mid_humidity)
                    midMoisture1.value = parseInt(data.mid_moisture1)

                    midTempValue = parseFloat(data.mid_temp)
                    midHumiValue = parseInt(data.mid_humidity)
                    midMoisture1Value = parseInt(data.mid_moisture1)
                })
            }
            function checkAutoMode() {
                if (statusServer == 1 && autoMode == 1) {
                    fetch(URL + "dataFarm.json")
                    .then(res => res.json())
                    .then(data => {
                        // Cek jika suhu berbeda dengan suhu sebelumnya
                        if (lastTemperature !== data.temperature) {
                            if (data.temperature < midTempValue) {
                                fanButton("off", document.getElementById("fan1-btn-off"), 1);
                            } else if (data.temperature > midTempValue) {
                                fanButton("on", document.getElementById("fan1-btn-on"), 1);
                            }
                            // Simpan suhu sekarang sebagai suhu terakhir
                            lastTemperature = data.temperature;
                        }
                        setTimeout(() => {
                            if (lastMoisture1 !== data.moisture1) {
                                if (data.moisture1 < midMoisture1Value) {
                                    pumpButton("on", document.getElementById("pump1-btn-on"), 1);
                                } else if (data.moisture1 > midMoisture1Value) {
                                    pumpButton("off", document.getElementById("pump1-btn-off"), 1);
                                }
                                // Simpan suhu sekarang sebagai suhu terakhir
                                lastMoisture1 = data.moisture1;
                            }
                        },
                            2000)
                    })
                    .catch(error => {
                        console.error("Error fetching data:",
                            error);
                    });
                }
            }


            function saveScheduleMode() {
                var pagiIpt = document.getElementById("pagi-ipt").value
                var siangIpt = document.getElementById("siang-ipt").value
                var soreIpt = document.getElementById("sore-ipt").value
                var malamIpt = document.getElementById("malam-ipt").value
                fetch(URL + "dataOperation.json",
                    {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            pagi_sc: pagiIpt,
                            siang_sc: siangIpt,
                            sore_sc: soreIpt,
                            malam_sc: malamIpt
                        })
                    })
                .then(res => {
                    if (res.ok) {
                        Toast.fire({
                            icon: "success",
                            title: "Pengaturan disimpan."
                        });
                    } else {
                        alert("error")
                    }
                })
                .catch(error => {
                    console.error("Terjadi kesalahan saat menyimpan:", error);
                    alert("Terjadi kesalahan saat menyimpan pengaturan.");
                });
            }
            function loadScheduleMode() {
                var pagiIpt = document.getElementById("pagi-ipt")
                var siangIpt = document.getElementById("siang-ipt")
                var soreIpt = document.getElementById("sore-ipt")
                var malamIpt = document.getElementById("malam-ipt")
                fetch(URL + "dataOperation.json")
                .then(res => res.json())
                .then(data => {
                    pagiIpt.value = parseInt(data.pagi_sc)
                    siangIpt.value = parseInt(data.siang_sc)
                    soreIpt.value = parseInt(data.sore_sc)
                    malamIpt.value = parseInt(data.malam_sc)

                    pagiTime = parseInt(data.pagi_sc)
                    siangTime = parseInt(data.siang_sc)
                    soreTime = parseInt(data.sore_sc)
                    malamTime = parseInt(data.malam_sc)
                })
            }
            function checkScheduleMode() {
                if (statusServer == 1 && scheduleMode == 1) {
                    fetch(URL + "dataOperation.json")
                    .then(res => res.json())
                    .then(data => {
                        let now = new Date();
                        let hours = now.getHours();

                        if (parseInt(data.pagi_sc) == hours) {
                            if (data.pagi_done == 0) {
                                fetch(URL + "dataOperation.json", {
                                    method: "PATCH",
                                    headers: {
                                        "Content-Type": "application/json"
                                },
                                    body: JSON.stringify({
                                        pagi_done: 1
                                })
                            })
                        .then(res => {
                            if (res.ok) {
                                pumpButton("on", document.getElementById("pump1-btn-on"), 1);
                                setTimeout(() => {
                                    fanButton("off", document.getElementById("fan1-btn-off"), 1);
                            }, 2000)
                        }
                        })
                    }
                } else if (parseInt(data.siang_sc) == hours) {
                    if (data.siang_done == 0) {
                        fetch(URL + "dataOperation.json", {
                            method: "PATCH",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                siang_done: 1
                            })
                        })
                        .then(res => {
                            if (res.ok) {
                                pumpButton("off", document.getElementById("pump1-btn-off"), 1);
                                setTimeout(() => {
                                    fanButton("on", document.getElementById("fan1-btn-on"), 1);
                                }, 2000)
                            }
                        })
                    }
                } else if (parseInt(data.sore_sc) == hours) {
                    if (data.sore_done == 0) {
                        fetch(URL + "dataOperation.json", {
                            method: "PATCH",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                sore_done: 1
                            })
                        })
                        .then(res => {
                            if (res.ok) {
                                pumpButton("off", document.getElementById("pump1-btn-off"), 1);
                                setTimeout(() => {
                                    fanButton("on", document.getElementById("fan1-btn-on"), 1);
                                }, 2000)
                            }
                        })
                    }
                } else if (parseInt(data.malam_sc) == hours) {
                    if (data.malam_done == 0) {
                        fetch(URL + "dataOperation.json", {
                            method: "PATCH",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                malam_done: 1
                            })
                        })
                        .then(res => {
                            if (res.ok) {

                                pumpButton("on", document.getElementById("pump1-btn-on"), 1);

                                setTimeout(() => {
                                    fanButton("off", document.getElementById("fan1-btn-off"), 1);
                                }, 2000)
                            }
                        })
                    }
                } else {
                    pumpButton("off", document.getElementById("pump1-btn-off"), 1);
                    fanButton("off", document.getElementById("fan1-btn-off"), 1);
                }
            })
            .catch(error => {
                console.error("Error fetching data:",
                    error);
            });
        }
    }

    setInterval(checkAutoMode, 3000);
    setInterval(checkScheduleMode, 10000);
    setInterval(getStatusServer, 500);
    setInterval(getSystemFarm, 1000);
    //     getAlert()
    getStatusServer();
    loadAutoMode()
    loadScheduleMode()
    getSystemFarm();
</script>
</body>

</html>